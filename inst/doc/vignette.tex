\documentclass{article}

\usepackage{Sweave}
\begin{document}
\input{vignette-concordance}
\begin{Schunk}
\begin{Sinput}
> library(PLIER)
\end{Sinput}
\end{Schunk}
\section{Vaccination Dataset}
Load data
\begin{Schunk}
\begin{Sinput}
> data(bloodCellMarkersIRISDMAP)
> data(svmMarkers)
> data(canonicalPathways)
> data(vacData)
\end{Sinput}
\end{Schunk}
Construct a joint pathway matrix by merging canonicalPathways, bloodCellMarkersIRISDMAP and svmMarkers and select genes appearing in both gene expression profile and the joint pathway matrix.
\begin{Schunk}
\begin{Sinput}
> allPaths=combinePaths(bloodCellMarkersIRISDMAP, svmMarkers,canonicalPathways)
> cm.genes=commonRows(allPaths, vacData)
\end{Sinput}
\end{Schunk}
Normalize the data and count the number of latent variables in the data by num.pc(). The result is 24. Then set max.iter = 250, k = 24 and all other parameters to be default.
\begin{Schunk}
\begin{Sinput}
> vacDataN=rowNorm(vacData)
> num.pc(vacDataN[cm.genes,])
\end{Sinput}
\begin{Soutput}
  [1] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1
 [38] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
 [75] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[112] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[149] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[1] 24
\end{Soutput}
\begin{Sinput}
> plierResult=PLIER(vacDataN[cm.genes,], allPaths[cm.genes,],k=24, trace=T, max.iter=150)
\end{Sinput}
\begin{Soutput}
[1] "L2 is set to 82.0573187891353"
[1] "L1 is set to 41.0286593945677"
[1] "L3 is set to 0.0111182399988254"
\end{Soutput}
\end{Schunk}
We correlate the decomposition result with SPVs from CellCODE. We have nice one-to-one  correspondence, though the "DendriticCell" signature from CellCODE is more closely related to the Type-I interferon transcriptional response so it is probably not cell-type induced variation.
\begin{Schunk}
\begin{Sinput}
> data(SPVs)
> plotMat(cor(t(plierResult$B), SPVs))
\end{Sinput}
\end{Schunk}
Visualize the cross-validation results
\begin{Schunk}
\begin{Sinput}
> plotMat(plierResult$Uauc)
\end{Sinput}
\end{Schunk}
Plot all of U and visualize the top genes
\begin{Schunk}
\begin{Sinput}
> plotU(plierResult,auc.cutoff = 0.5, pval.cutoff = 1)
> plotTopZ(plierResult, vacDataN, allPaths, top = 10)
\end{Sinput}
\end{Schunk}
The "PID_ATF2_PATHWAY" looks a little tenuous and we can check its statistics.
\begin{Schunk}
\begin{Sinput}
> plierResult$summary[which(plierResult$summary$`LV index`==3),]
\end{Sinput}
\begin{Soutput}
           pathway LV index       AUC   p-value
5 PID_ATF2_PATHWAY        3 0.5718064 0.0536596
\end{Soutput}
\end{Schunk}
The association with "PID_ATF2_PATHWAY" is not significant: this pathway has only 42 genes that are also present in the dataset which makes achieving significance harder. In general, the signaling pathway  doesn't have perfect correspondence to the transcriptional signature, but the transcriptional signature can still be of interest and we can plot it by itself with more genes. It looks like an AP1 pathway that regulates IL8 transcription possibly downstream of TNF signaling (we have FOS, JUNB, FOSB (not actually a memeber of the PID_ATF2_PATHWAY geneset))
\begin{Schunk}
\begin{Sinput}
> plotTopZ(plierResult, vacDataN, allPaths, index=c(3), top=50)
\end{Sinput}
\end{Schunk}
\section{HCC Dataset}
Load data
\begin{Schunk}
\begin{Sinput}
> data(HCCdataTumor)
> data(canonicalPathways)
> data(chemgenPathways)
> data(oncogenicPathways)
\end{Sinput}
\end{Schunk}
Construct a joint pathway matrix by merging canonicalPathways, chemgenPathways and oncogenicPathways and select genes appearing in both gene expression profile and the joint pathway matrix.
\begin{Schunk}
\begin{Sinput}
> CancerPath=combinePaths(canonicalPathways, chemgenPathways, oncogenicPathways)
> cmHCC=commonRows(HCCdataTumor, CancerPath)
> 
\end{Sinput}
\end{Schunk}
Remove small pathways, not strictly necessary but saves computation time by making the pathway/geneset matrix smaller
\begin{Schunk}
\begin{Sinput}
> ii=which(colSums(CancerPath[cmHCC,])<20)
> HCCpath=CancerPath[, -ii]
\end{Sinput}
\end{Schunk}
Prescale the data
\begin{Schunk}
\begin{Sinput}
> HCCdataN=rowNorm(HCCdataTumor[cmHCC,])
\end{Sinput}
\end{Schunk}
Precompute Chat, which is used to define active pathways and is expensive for large pathway sets. It's helpful if we want to run plier with different parameters
\begin{Schunk}
\begin{Sinput}
> HCCchat=computeChat(CancerPath[cmHCC,])
\end{Sinput}
\end{Schunk}
Compute the number of latent variables by num.pc(HCCdataUse) and the result is 52. Then set k = 52 and all other parameters to be default.
\begin{Schunk}
\begin{Sinput}
> plierResultHCC=PLIER(HCCdataN, CancerPath[cmHCC,], k = 52, Chat = HCCchat, trace=T)
\end{Sinput}
\begin{Soutput}
[1] "L2 is set to 132.670764279278"
[1] "L1 is set to 66.3353821396389"
[1] "L3 is set to 0.00807273868235351"
\end{Soutput}
\end{Schunk}
Plot the result with a high AUC cutoff so it is not too busy
\begin{Schunk}
\begin{Sinput}
> plotU(plierResultHCC, auc.cutoff = 0.9)
\end{Sinput}
\end{Schunk}
We found two immune components, interferon alpha and genes related to interferon gamma/CD8/Th1 response. The component 40 has many pathways, it is named with the top pathway but "inPathway" refers to their union.
\begin{Schunk}
\begin{Sinput}
> plotTopZ(plierResultHCC, HCCdataN, CancerPath, index=c(26, 40), top = 20)
\end{Sinput}
\end{Schunk}
\end{document}
